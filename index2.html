<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pandora Shorts Loop</title>
  <meta name="description" content="Continuous loop of Pandora YouTube Shorts." />
  <style>
    :root {
      color-scheme: light;
      --rose: #f7f0f7;
      --rose-soft: #fdf7fb;
      --shadow: rgba(0, 0, 0, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e1c5c9;
      font-family: sans-serif;
      overflow: hidden;
    }

    .player-shell {
      width: min(520px, 90vw);
      aspect-ratio: 9 / 16;
      border-radius: 32px;
      overflow: hidden;
      box-shadow: 0 32px 70px var(--shadow);
      background: #000;
      position: relative;
    }

    .player-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.02);
      pointer-events: none;
    }

    .player-guard {
      position: absolute;
      inset: 0;
      z-index: 1;
      background: transparent;
      pointer-events: auto;
    }

    .player-frame {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    .loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      z-index: 2;
      pointer-events: none;
    }

    .loading::after {
      content: "";
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid rgba(214, 129, 163, 0.25);
      border-top-color: rgba(179, 87, 132, 0.9);
      animation: spin 1s linear infinite;
    }

    .loading.is-hidden {
      opacity: 0;
      visibility: hidden;
      transition: opacity 280ms ease;
    }

    @keyframes spin {
      to {
        transform: rotate(1turn);
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loadingIndicator" aria-hidden="true"></div>
  <div class="player-shell">
    <object
      id="shortsPlayer"
      class="player-frame"
      type="text/html"
      data=""
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share">
      <param name="allowfullscreen" value="true" />
    </object>
    <div class="player-guard" aria-hidden="true"></div>
  </div>

  <script>
    (function () {
      const PROXY_ORIGIN = 'https://r.jina.ai/';
      const DEFAULT_SHORTS_SOURCE = 'https://www.youtube.com/@TheOfficialPandora/shorts';
      const DEFAULT_BACKGROUND = '#e1c5c9';

      function normalizeShortsLocation(value) {
        if (typeof value !== 'string') {
          return null;
        }
        let candidate = value.trim();
        if (!candidate) {
          return null;
        }
        if (!/^https?:\/\//i.test(candidate)) {
          candidate = `https://${candidate}`;
        }
        try {
          const url = new URL(candidate);
          const hostname = url.hostname.toLowerCase();
          const allowedHosts = new Set(['www.youtube.com', 'youtube.com', 'm.youtube.com']);
          if (!allowedHosts.has(hostname)) {
            return null;
          }
          if (!url.pathname.toLowerCase().includes('/shorts')) {
            return null;
          }
          url.hash = '';
          return url.toString();
        } catch (error) {
          return null;
        }
      }

      function resolveShortsLocation() {
        const params = new URLSearchParams(window.location.search);
        const candidateKeys = ['shorts', 'source', 'src', 'channel', 'url'];
        for (const key of candidateKeys) {
          const normalized = normalizeShortsLocation(params.get(key));
          if (normalized) {
            return normalized;
          }
        }
        if (window.location.search.length > 1) {
          const rawQuery = window.location.search.slice(1);
          const attempts = [rawQuery];
          try {
            attempts.unshift(decodeURIComponent(rawQuery));
          } catch (error) {
            // ignore decode issues and fall back to raw value
          }
          for (const attempt of attempts) {
            const normalized = normalizeShortsLocation(attempt);
            if (normalized) {
              return normalized;
            }
          }
        }
        return null;
      }

      function toProxyUrl(target) {
        if (!target) {
          return `${PROXY_ORIGIN}${DEFAULT_SHORTS_SOURCE}`;
        }
        if (target.startsWith(PROXY_ORIGIN)) {
          return target;
        }
        return `${PROXY_ORIGIN}${target}`;
      }

      function normalizeColor(value) {
        if (typeof value !== 'string') {
          return null;
        }
        const candidate = value.trim();
        if (!candidate) {
          return null;
        }
        const prefixed = candidate.startsWith('#') ? candidate : `#${candidate}`;
        return /^#([0-9a-f]{3}|[0-9a-f]{4}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(prefixed)
          ? prefixed
          : null;
      }

      function resolveBackgroundColor() {
        const params = new URLSearchParams(window.location.search);
        const candidateKeys = ['bg', 'background', 'colour', 'color'];
        for (const key of candidateKeys) {
          const normalized = normalizeColor(params.get(key));
          if (normalized) {
            return normalized;
          }
        }

        const hashColor = normalizeColor(window.location.hash.slice(1));
        if (hashColor) {
          return hashColor;
        }

        return DEFAULT_BACKGROUND;
      }

      const rawShortsSource = resolveShortsLocation() || DEFAULT_SHORTS_SOURCE;
      const SOURCE = toProxyUrl(rawShortsSource);
      document.body.style.background = resolveBackgroundColor();
      const player = document.getElementById('shortsPlayer');
      const loader = document.getElementById('loadingIndicator');
      let playlistUrl = '';

      function hideLoader() {
        loader.classList.add('is-hidden');
      }

      function showLoader() {
        loader.classList.remove('is-hidden');
      }

      function buildEmbedUrl(ids) {
        if (!ids.length) {
          return '';
        }
        const [first, ...rest] = ids;
        const params = new URLSearchParams({
          autoplay: '1',
          playsinline: '1',
          rel: '0',
          modestbranding: '1',
          controls: '0',
          enablejsapi: '1',
          mute: '1',
        });
        const playlistIds = rest.length ? ids : [first];
        params.set('playlist', playlistIds.join(','));
        params.set('loop', '1');
        params.set('origin', window.location.origin);
        return `https://www.youtube.com/embed/${first}?${params.toString()}`;
      }

      function withReloadParam(url) {
        try {
          const parsed = new URL(url);
          parsed.searchParams.set('reload', Date.now().toString(36));
          return parsed.toString();
        } catch (error) {
          return url;
        }
      }

      function applySource(url, options = {}) {
        if (!url) return;
        const { force = false } = options;
        const finalUrl = force ? withReloadParam(url) : url;
        showLoader();
        player.dataset.state = 'loading';
        player.dataset.currentSrc = url;
        const onLoad = () => {
          hideLoader();
          player.dataset.state = 'ready';
          player.removeEventListener('load', onLoad);
        };
        player.addEventListener('load', onLoad);
        player.setAttribute('data', finalUrl);
        window.setTimeout(hideLoader, 4000);
      }

      async function loadShorts() {
        try {
          const response = await fetch(SOURCE);
          if (!response.ok) {
            throw new Error(`Failed to fetch shorts (${response.status})`);
          }

          const text = await response.text();
          const ids = [];
          const seen = new Set();

          for (const match of text.matchAll(/https:\/\/www\.youtube\.com\/shorts\/([\w-]+)/g)) {
            const id = match[1];
            if (!id || seen.has(id)) {
              continue;
            }
            seen.add(id);
            ids.push(id);
            if (ids.length >= 15) {
              break;
            }
          }

          if (!ids.length) {
            throw new Error('No shorts found');
          }

          const embedUrl = buildEmbedUrl(ids);
          if (!embedUrl) {
            throw new Error('Unable to resolve embed URL');
          }

          playlistUrl = embedUrl;
          applySource(playlistUrl);
        } catch (error) {
          console.error(error);
          hideLoader();
        }
      }

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && playlistUrl) {
          applySource(playlistUrl, { force: true });
        }
      });

      loadShorts();
    })();
  </script>
</body>
</html>
